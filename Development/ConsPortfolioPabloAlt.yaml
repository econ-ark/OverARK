initializer_block:
    dynamics:
        - start
        - kLvl = 0.0
        - pLvlPrev = 1.0
        - RiskyShare = 0.0


portfolio_pre_block:
    explain: pre-decision portfolio block

    symbols:
        states: [kLvl, pLvlPrev, RiskyShare]
        parameters: [Rfree, RiskyMean, RiskyStd]
        distributions: [RiskyDstn]

    dynamics:
        - Risky ~ RiskyDstn
        - Rport = (1-RiskyShare)*Rfree + RiskyShare*Risky
        - bLvl = Rport * kLvl

    calibration:
        Rfree: 1.0
        RiskyMean: 1.08
        RiskyStd: 0.07
        RiskyDstn: !LogNormal:
            mean: log(RiskyMean) - RiskyStd^2 / 2
            stdev: RiskyStd
            pbounds: [0.001, 0.999]


consumption_pre_block:
    explain: pre-decision consumption block

    symbols:
        states: [bLvl, pLvlPrev]
        parameters: [PermGroFac, PermShkStd, TranShkStd, UnempPrb, UnempBenefit]
        distributions: [PermShkDstn, TranShkDstn]

    dynamics:
        - PermShk ~ PermShkDstn
        - TranShk ~ TranShkDstn
        - pLvl = PermGroFac * PermShk * pLvlPrev
        - yLvl = TranShk * pLvl
        - mLvl = bLvl + yLvl

    calibration:
        PermGroFac: 1.01
        PermShkStd: 0.1
        TranShkStd: 0.1
        UnempPrb: 0.05
        IncUnemp: 0.3
        TranShkScaleFac: log(UnempBenefit * UnempPrb / (1-UnempPrb))
        PermShkDstn: !LogNormal
            mean: -PermShkStd^2 / 2
            stdev: PermShkStd
            pbounds: [0.001, 0.999]
        TranShkDstn: !Mixed
            probs: [UnempPrb, 1. - UnempPrb]
            distributions:
                - !ConstantDstn: UnempBenefit
                - !LogNormal:
                    mean: TranShkScaleFac - TranShkStd^2 / 2
                    stdev: TranShkStd^2 
                    xbounds: [UnempBenefit, 1.0/UnempBenefit]
            

consumption_choice_block:
    explain: consumption-decision-time block

    symbols:
        states: [mLvl, pLvl]
        controls: cLvl            
        parameters: [CRRA, BoroCnstArt]

    definitions:
        aLvl = mLvl - cLvl
        aNrm = aLvl / pLvl

    dynamics:
        - cLvl @ (mLvl,pLvl) | aNrm >= BoroCnstArt

    felicity:
        cLvl^(1-CRRA) / (1-CRRA)

    calibration:
        CRRA: 2.0
        BoroCnstArt: 0.


portfolio_choice_block:
    explain: portfolio share-decision-time block

    symbols:
        states: [aLvl, pLvl]
        controls: RiskyShare

    dynamics:
        - RiskyShare @ (mLvl,pLvl) | [RiskyShare >= 0.0, RiskyShare <= 1.0]


cons_portfolio_post_block:
    explain: post-decision consumption-saving block with permanent and transitory income shocks and portfolio risk

    symbols:
        states: [aLvl, pLvl, RiskyShare]
        parameters: LivPrb
        distributions: MortShkDstn

    dynamics:
        - dies ~ MortShkDstn

    calibration:
        LivPrb: 0.98
        MortShkDstn: !Bernoulli:
            prob: LivPrb


time_loop:
    tick: True
    twist:
        pLvl: pLvlPrev
        aLvl: kLvl

cons_portfolio_period:
    content:
        - link(portfolio_pre_block, consumption_pre_block)
        - link(consumption_pre_block, consumption_choice_block)
        - link(consumption_choice_block, portfolio_choice_block)
        - link(portfolio_choice_block, cons_portfolio_post_block)


cons_portfolio_model:
    content:
        - link(initializer_block, cons_portfolio_period)
        - link(cons_portfolio_period, time_loop, dies ? [cons_portfolio_period, stop])


portfolio_consumer:
    model: cons_portfolio_model
    discount: 0.95
    
